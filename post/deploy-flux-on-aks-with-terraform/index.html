

<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

 


      <title>Terraformを使ってAKS上にFluxを導入する手順とデモ - </title>

  <meta name="description" content="はじめに
GitOps は、開発者がコードを Git リポジトリにプッシュすることで自動的にインフラストラクチャーが更新される仕組みです。
Flux は、GitOps を実現するためのツールであり、Kubernetes の manifest ファイルを Git リポジトリに保存し、変更があるたびに自動でデプロイすることができます。
本記事では、Terraform を用いて AKS 上に Flux を導入する手順を説明し、GitOps のデモを行います。
AKS 上に Flux を導入する手順
連携先の GitHub リポジトリの準備
GitHub リポジトリが空だと Terraform の実行時にエラーになるため、main ブランチに readme か何かを入れておいてください。
続いて GitHub との認証情報の準備です。
今回は Deploy key を用いて Flux から GitHub に接続する方針で説明します。
Deploy key の作成方法は下記です。

接続に使用する SSH キーを生成します

参考：https://docs.github.com/ja/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent#generating-a-new-ssh-key


対象のリポジトリの「Setting」から、「Deploy keys」を開きます
「Add deploy key」をクリックします
Title に任意の名称を設定し、SSH キーの公開鍵をコピペし、「Allow write access」のチェックを入れて「Add key」します

SSH キーの秘密鍵は Terraform の実行時に必要になります。
AKS と Flux の導入
AKS の作成と Flux の導入は Terraform で実現しましょう。"><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "備忘録",
    
    "url": "https:\/\/blog.pokapu.jp\/"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/blog.pokapu.jp\/"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https:\/\/blog.pokapu.jp\/",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https:\/\/blog.pokapu.jp\/post\/deploy-flux-on-aks-with-terraform\/",
          "name": "Terraformを使って aks上に fluxを導入する手順とデモ"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : ""
  },
  "headline": "Terraformを使ってAKS上にFluxを導入する手順とデモ",
  "description" : "はじめに GitOps は、開発者がコードを Git リポジトリにプッシュすることで自動的にインフラストラクチャーが更新される仕組みです。\nFlux は、GitOps を実現するためのツールであり、Kubernetes の manifest ファイルを Git リポジトリに保存し、変更があるたびに自動でデプロイすることができます。\n本記事では、Terraform を用いて AKS 上に Flux を導入する手順を説明し、GitOps のデモを行います。\nAKS 上に Flux を導入する手順 連携先の GitHub リポジトリの準備 GitHub リポジトリが空だと Terraform の実行時にエラーになるため、main ブランチに readme か何かを入れておいてください。\n続いて GitHub との認証情報の準備です。 今回は Deploy key を用いて Flux から GitHub に接続する方針で説明します。\nDeploy key の作成方法は下記です。\n接続に使用する SSH キーを生成します 参考：https:\/\/docs.github.com\/ja\/authentication\/connecting-to-github-with-ssh\/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent#generating-a-new-ssh-key 対象のリポジトリの「Setting」から、「Deploy keys」を開きます 「Add deploy key」をクリックします Title に任意の名称を設定し、SSH キーの公開鍵をコピペし、「Allow write access」のチェックを入れて「Add key」します SSH キーの秘密鍵は Terraform の実行時に必要になります。\nAKS と Flux の導入 AKS の作成と Flux の導入は Terraform で実現しましょう。\n",
  "inLanguage" : "en",
  "wordCount":  474 ,
  "datePublished" : "2023-07-06T09:36:15\u002b09:00",
  "dateModified" : "2023-07-06T09:36:15\u002b09:00",
  "image" : "https:\/\/blog.pokapu.jp\/",
  "keywords" : [ "AKS, Azure Kubernetes Services, Terraform, GitOps, Flux" ],
  "mainEntityOfPage" : "https:\/\/blog.pokapu.jp\/post\/deploy-flux-on-aks-with-terraform\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https:\/\/blog.pokapu.jp\/",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https:\/\/blog.pokapu.jp\/",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>


<meta property="og:title" content="Terraformを使ってAKS上にFluxを導入する手順とデモ" />
<meta property="og:description" content="はじめに
GitOps は、開発者がコードを Git リポジトリにプッシュすることで自動的にインフラストラクチャーが更新される仕組みです。
Flux は、GitOps を実現するためのツールであり、Kubernetes の manifest ファイルを Git リポジトリに保存し、変更があるたびに自動でデプロイすることができます。
本記事では、Terraform を用いて AKS 上に Flux を導入する手順を説明し、GitOps のデモを行います。
AKS 上に Flux を導入する手順
連携先の GitHub リポジトリの準備
GitHub リポジトリが空だと Terraform の実行時にエラーになるため、main ブランチに readme か何かを入れておいてください。
続いて GitHub との認証情報の準備です。
今回は Deploy key を用いて Flux から GitHub に接続する方針で説明します。
Deploy key の作成方法は下記です。

接続に使用する SSH キーを生成します

参考：https://docs.github.com/ja/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent#generating-a-new-ssh-key


対象のリポジトリの「Setting」から、「Deploy keys」を開きます
「Add deploy key」をクリックします
Title に任意の名称を設定し、SSH キーの公開鍵をコピペし、「Allow write access」のチェックを入れて「Add key」します

SSH キーの秘密鍵は Terraform の実行時に必要になります。
AKS と Flux の導入
AKS の作成と Flux の導入は Terraform で実現しましょう。">
<meta property="og:url" content="https://blog.pokapu.jp/post/deploy-flux-on-aks-with-terraform/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="備忘録" />

  <meta name="twitter:title" content="Terraformを使ってAKS上にFluxを導入する手順とデモ" />
  <meta name="twitter:description" content="はじめに
GitOps は、開発者がコードを Git リポジトリにプッシュすることで自動的にインフラストラクチャーが更新される仕組みです。
Flux は、GitOps を実現するためのツールであり、Kubernetes の manifest ファイルを Git リポジトリに保存し、変更があるたびに自動でデプロイすることができます。
本記事では、Terraform を用いて AKS 上に Flux  …">
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="@matsueda_2022" />
  <meta name="twitter:creator" content="@matsueda_2022" />
  <meta name="generator" content="Hugo 0.140.1">
  <link rel="alternate" href="https://blog.pokapu.jp/index.xml" type="application/rss+xml" title="備忘録"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.css" integrity="sha384-3UiQGuEI4TTMaFmGIZumfRPtfKQ3trwQE2JgosJxCnGmQpL/lJdjpcHkaaFwHlcI" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.6.0/css/all.css" integrity="sha384-h/hnnw1Bi4nbpD6kE7nYfCXzovi622sY5WBxww8ARKwpdLj5kUWjRuyiXaD1U2JT" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous"><link rel="stylesheet" href="https://blog.pokapu.jp/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" /><link rel="stylesheet" href="https://blog.pokapu.jp/css/syntax.css" /><link rel="stylesheet" href="https://blog.pokapu.jp/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">

      <script async src="https://www.googletagmanager.com/gtag/js?id=G-M6XY8HL7QN"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-M6XY8HL7QN');
        }
      </script>
  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://blog.pokapu.jp/">備忘録</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Privacy Policy" href="/privacy/">Privacy Policy</a>
            </li>
          
        

        

        
      </ul>
    </div>

    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              
                <h1>Terraformを使ってAKS上にFluxを導入する手順とデモ</h1>
              
              
              
              
                <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on July 6, 2023
  
  
  
  
    
      &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;
    
  
  
</span>


              
            </div>
          </div>
        </div>
      </div>
    </div>
  
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        <h2 id="はじめに">はじめに</h2>
<p>GitOps は、開発者がコードを Git リポジトリにプッシュすることで自動的にインフラストラクチャーが更新される仕組みです。</p>
<p>Flux は、GitOps を実現するためのツールであり、Kubernetes の manifest ファイルを Git リポジトリに保存し、変更があるたびに自動でデプロイすることができます。</p>
<p>本記事では、Terraform を用いて AKS 上に Flux を導入する手順を説明し、GitOps のデモを行います。</p>
<h2 id="aks-上に-flux-を導入する手順">AKS 上に Flux を導入する手順</h2>
<h3 id="連携先の-github-リポジトリの準備">連携先の GitHub リポジトリの準備</h3>
<p>GitHub リポジトリが空だと Terraform の実行時にエラーになるため、main ブランチに readme か何かを入れておいてください。</p>
<p>続いて GitHub との認証情報の準備です。
今回は Deploy key を用いて Flux から GitHub に接続する方針で説明します。</p>
<p>Deploy key の作成方法は下記です。</p>
<ol>
<li>接続に使用する SSH キーを生成します
<ul>
<li>参考：<a href="https://docs.github.com/ja/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent#generating-a-new-ssh-key">https://docs.github.com/ja/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent#generating-a-new-ssh-key</a></li>
</ul>
</li>
<li>対象のリポジトリの「Setting」から、「Deploy keys」を開きます</li>
<li>「Add deploy key」をクリックします</li>
<li>Title に任意の名称を設定し、SSH キーの公開鍵をコピペし、「Allow write access」のチェックを入れて「Add key」します</li>
</ol>
<p>SSH キーの秘密鍵は Terraform の実行時に必要になります。</p>
<h2 id="aks-と-flux-の導入">AKS と Flux の導入</h2>
<p>AKS の作成と Flux の導入は Terraform で実現しましょう。</p>
<p>主に azurerm_kubernetes_cluster と flux_bootstrap_git を利用します。検証時点では flux_bootstrap_git のバージョンは <code>1.0.0-rc.5</code> でした。</p>
<h3 id="maintf">main.tf</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-terraform" data-lang="terraform"><span style="display:flex;"><span><span style="color:#a6e22e">terraform</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">required_providers</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">kubernetes</span> = {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">source</span> = <span style="color:#e6db74">&#34;hashicorp/kubernetes&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">flux</span> = {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">source</span>  = <span style="color:#e6db74">&#34;fluxcd/flux&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">version</span> = <span style="color:#e6db74">&#34;1.0.0-rc.5&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">provider</span> <span style="color:#e6db74">&#34;azurerm&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">subscription_id</span> = var.<span style="color:#a6e22e">subscription_id</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">client_id</span>       = var.<span style="color:#a6e22e">sp_client_id</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">client_secret</span>   = var.<span style="color:#a6e22e">sp_client_secret</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">tenant_id</span>       = var.<span style="color:#a6e22e">sp_tenant_id</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">features</span> {}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">provider</span> <span style="color:#e6db74">&#34;kubernetes&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">host</span>                   = <span style="color:#a6e22e">azurerm_kubernetes_cluster</span>.<span style="color:#a6e22e">this</span>.<span style="color:#a6e22e">kube_config</span>.<span style="color:#ae81ff">0</span>.<span style="color:#a6e22e">host</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">client_certificate</span>     = base64decode(<span style="color:#a6e22e">azurerm_kubernetes_cluster</span>.<span style="color:#a6e22e">this</span>.<span style="color:#a6e22e">kube_config</span>.<span style="color:#ae81ff">0</span>.<span style="color:#a6e22e">client_certificate</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">client_key</span>             = base64decode(<span style="color:#a6e22e">azurerm_kubernetes_cluster</span>.<span style="color:#a6e22e">this</span>.<span style="color:#a6e22e">kube_config</span>.<span style="color:#ae81ff">0</span>.<span style="color:#a6e22e">client_key</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">cluster_ca_certificate</span> = base64decode(<span style="color:#a6e22e">azurerm_kubernetes_cluster</span>.<span style="color:#a6e22e">this</span>.<span style="color:#a6e22e">kube_config</span>.<span style="color:#ae81ff">0</span>.<span style="color:#a6e22e">cluster_ca_certificate</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">provider</span> <span style="color:#e6db74">&#34;flux&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">kubernetes</span> = {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">host</span>                   = <span style="color:#a6e22e">azurerm_kubernetes_cluster</span>.<span style="color:#a6e22e">this</span>.<span style="color:#a6e22e">kube_config</span>.<span style="color:#ae81ff">0</span>.<span style="color:#a6e22e">host</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">username</span>               = <span style="color:#a6e22e">azurerm_kubernetes_cluster</span>.<span style="color:#a6e22e">this</span>.<span style="color:#a6e22e">kube_config</span>.<span style="color:#ae81ff">0</span>.<span style="color:#a6e22e">username</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">password</span>               = <span style="color:#a6e22e">azurerm_kubernetes_cluster</span>.<span style="color:#a6e22e">this</span>.<span style="color:#a6e22e">kube_config</span>.<span style="color:#ae81ff">0</span>.<span style="color:#a6e22e">password</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">client_certificate</span>     = base64decode(<span style="color:#a6e22e">azurerm_kubernetes_cluster</span>.<span style="color:#a6e22e">this</span>.<span style="color:#a6e22e">kube_config</span>.<span style="color:#ae81ff">0</span>.<span style="color:#a6e22e">client_certificate</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">client_key</span>             = base64decode(<span style="color:#a6e22e">azurerm_kubernetes_cluster</span>.<span style="color:#a6e22e">this</span>.<span style="color:#a6e22e">kube_config</span>.<span style="color:#ae81ff">0</span>.<span style="color:#a6e22e">client_key</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">cluster_ca_certificate</span> = base64decode(<span style="color:#a6e22e">azurerm_kubernetes_cluster</span>.<span style="color:#a6e22e">this</span>.<span style="color:#a6e22e">kube_config</span>.<span style="color:#ae81ff">0</span>.<span style="color:#a6e22e">cluster_ca_certificate</span>)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">git</span> = {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">url</span> = <span style="color:#e6db74">&#34;ssh://git@github.com/</span><span style="color:#e6db74">${</span>var.<span style="color:#a6e22e">github_organization_name</span><span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>var.<span style="color:#a6e22e">github_repository_name</span><span style="color:#e6db74">}</span><span style="color:#e6db74">.git&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ssh</span> = {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">username</span>    = <span style="color:#e6db74">&#34;git&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">private_key</span> = file(var.<span style="color:#a6e22e">gitops_ssh_private_key_file</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">locals</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">resource_group_name</span> = <span style="color:#e6db74">&#34;rg-gitops&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">aks_name</span>            = <span style="color:#e6db74">&#34;aks-gitops&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">namespace_flux</span>      = <span style="color:#e6db74">&#34;flux-system&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;azurerm_resource_group&#34;</span> <span style="color:#e6db74">&#34;this&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">name</span>     = <span style="color:#a6e22e">local</span>.<span style="color:#a6e22e">resource_group_name</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">location</span> = <span style="color:#e6db74">&#34;japaneast&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;azurerm_kubernetes_cluster&#34;</span> <span style="color:#e6db74">&#34;this&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">name</span>                      = <span style="color:#a6e22e">local</span>.<span style="color:#a6e22e">aks_name</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">location</span>                  = <span style="color:#e6db74">&#34;japaneast&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">resource_group_name</span>       = <span style="color:#a6e22e">azurerm_resource_group</span>.<span style="color:#a6e22e">this</span>.<span style="color:#a6e22e">name</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">automatic_channel_upgrade</span> = <span style="color:#e6db74">&#34;patch&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">dns_prefix</span>                = <span style="color:#e6db74">&#34;dns&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">default_node_pool</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">name</span>       = <span style="color:#e6db74">&#34;system&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">node_count</span> = <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">vm_size</span>    = <span style="color:#e6db74">&#34;Standard_B2s&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">type</span>       = <span style="color:#e6db74">&#34;VirtualMachineScaleSets&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">identity</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">type</span> = <span style="color:#e6db74">&#34;SystemAssigned&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">network_profile</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">network_plugin</span> = <span style="color:#e6db74">&#34;azure&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;kubernetes_namespace&#34;</span> <span style="color:#e6db74">&#34;flux&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">metadata</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">name</span> = <span style="color:#a6e22e">local</span>.<span style="color:#a6e22e">namespace_flux</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">depends_on</span> = [
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">azurerm_kubernetes_cluster</span>.<span style="color:#a6e22e">this</span>
</span></span><span style="display:flex;"><span>  ]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">lifecycle</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ignore_changes</span> = [
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">metadata</span>
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;flux_bootstrap_git&#34;</span> <span style="color:#e6db74">&#34;this&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">namespace</span> = <span style="color:#a6e22e">kubernetes_namespace</span>.<span style="color:#a6e22e">flux</span>.<span style="color:#a6e22e">metadata</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">name</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">path</span>      = <span style="color:#e6db74">&#34;clusters/</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">local</span>.<span style="color:#a6e22e">aks_name</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="variablestf">variables.tf</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-terraform" data-lang="terraform"><span style="display:flex;"><span><span style="color:#66d9ef">variable</span> <span style="color:#e6db74">&#34;subscription_id&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">description</span> = <span style="color:#e6db74">&#34;AKS作成先のサブスクリプションのID&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">type</span>        = <span style="color:#a6e22e">string</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">variable</span> <span style="color:#e6db74">&#34;sp_tenant_id&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">description</span> = <span style="color:#e6db74">&#34;AzureのテナントのID&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">type</span>        = <span style="color:#a6e22e">string</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">variable</span> <span style="color:#e6db74">&#34;sp_client_id&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">description</span> = <span style="color:#e6db74">&#34;Azureに接続するサービスプリンシパルのID&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">type</span>        = <span style="color:#a6e22e">string</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">variable</span> <span style="color:#e6db74">&#34;sp_client_secret&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">description</span> = <span style="color:#e6db74">&#34;Azureに接続するサービスプリンシパルのシークレット&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">sensitive</span>   = <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">type</span>        = <span style="color:#a6e22e">string</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">variable</span> <span style="color:#e6db74">&#34;github_organization_name&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">description</span> = <span style="color:#e6db74">&#34;GitHubリポジトリが所属する組織名またはユーザー名&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">type</span>        = <span style="color:#a6e22e">string</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">variable</span> <span style="color:#e6db74">&#34;github_repository_name&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">description</span> = <span style="color:#e6db74">&#34;GitHubリポジトリ名&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">type</span>        = <span style="color:#a6e22e">string</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">variable</span> <span style="color:#e6db74">&#34;gitops_ssh_private_key_file&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">description</span> = <span style="color:#e6db74">&#34;GitHubリポジトリのDeploy keyの秘密鍵が記載されたファイルパス&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">type</span>        = <span style="color:#a6e22e">string</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>terraform apply 時は、variables.tf の description の説明を参考にパラメータを渡してあげてください。</p>
<p>provider の記述が特徴的かと思います。
namespace の作成や Flux の導入時に kubernetes への接続情報が必要になるのですが、 <code>provider &quot;kubernetes&quot;</code> や <code> provider &quot;flux&quot;</code> の記載で azurerm_kubernetes_cluster のアウトプットから拾うようにしています。</p>
<p>他は各リソースの terraform ドキュメントに記載されている内容とあまり差が無いと思います。</p>
<h2 id="gitops-のデモ">GitOps のデモ</h2>
<p>terraform apply が成功すると、GitOps 用の GitHub リポジトリ内に <code>clusters/aks-gitops/flux-system</code> フォルダが作成され、ここに Flux の管理ファイルが保管されています。</p>
<p>main ブランチの <code>clusters/aks-gitops</code> フォルダ内が Flux により監視されているので、ここに好きなファイル名.yaml でマニフェストファイルを追加してあげると AKS にデプロイされます。</p>
<p>GitHub を監視する周期はデフォルト設定だと 1 分です。</p>
<p>試しに下記のマニフェストファイルを <code>clusters/aks-gitops/sample-namespace.yaml</code> として main ブランチにコミット、プッシュしてみましょう。</p>
<h3 id="sample-namespaceyaml">sample-namespace.yaml</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Namespace</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">sample</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">sample</span>
</span></span></code></pre></div><p>kubectl apply すると <code>sample</code> という名前の namespace が作成されるマニフェストファイルですね。</p>
<p>namespace が作成されたかどうかは好きな方法で確認して OK ですが、Azure ポータルから見るのが気軽ですかね？</p>
<p>Azure ポータルから Terraform で作成された AKS の「Kubenetes リソース」→「名前空間」を選択してください。</p>
<p>kubectl apply せずに、マニフェストファイルをプッシュしてから 1 分以内に namespace が作成されたと思います！</p>
<p>ファイルの削除をコミットすれば namespace が削除されます、素晴らしいー</p>
<h2 id="まとめ">まとめ</h2>
<p>Terraform を使用することで、簡単に Flux を用いた GitOps 環境が構築できることが分かりました。</p>
<p>GitOps の実現手段としては ArgoCD もありますが、Flux の利用もぜひ検討してみてください。</p>


        
          <div class="blog-tags">
            
              
              <a href="https://blog.pokapu.jp/tags/aks/">AKS</a>&nbsp;
            
              
              <a href="https://blog.pokapu.jp/tags/azure-kubernetes-services/">Azure Kubernetes Services</a>&nbsp;
            
              
              <a href="https://blog.pokapu.jp/tags/terraform/">Terraform</a>&nbsp;
            
              
              <a href="https://blog.pokapu.jp/tags/gitops/">GitOps</a>&nbsp;
            
              
              <a href="https://blog.pokapu.jp/tags/flux/">Flux</a>&nbsp;
            
          </div>
        

        

        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://blog.pokapu.jp/post/what-if-chatgpt-made-a-song-for-kids/" data-toggle="tooltip" data-placement="top" title="ChatGPT が子供向けの曲を作ったらどうなる？">&larr; Previous Post</a>
            </li>
          
          
            <li class="next">
              <a href="https://blog.pokapu.jp/post/learn-about-premium-options-for-storage-accounts/" data-toggle="tooltip" data-placement="top" title="ストレージアカウントのPremiumな選択肢を覚えてみる">Next Post &rarr;</a>
            </li>
          
        </ul>
      


      

    </div>
  </div>
</div>

      <footer>
  <div class="container">
    
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
		
		  <a href="https://github.com/hirokimatsueda" title="GitHub">
		
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
		
		  <a href="https://twitter.com/matsueda_2022" title="Twitter">
		
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-x-twitter fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
		
		  <a href="https://linkedin.com/in/hiroki-matsueda-3867a32b2" title="LinkedIn">
		
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
        </ul>
        <p class="credits copyright text-muted">
          

          &nbsp;&bull;&nbsp;&copy;
          
            2024
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://blog.pokapu.jp/">備忘録</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="https://gohugo.io">Hugo v0.140.1</a> powered &nbsp;&bull;&nbsp; Theme <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> adapted from <a href="https://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a>
          
        </p>
      </div>
    </div>
  </div>
</footer><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.js" integrity="sha384-G0zcxDFp5LWZtDuRMnBkk3EphCK1lhEf4UEyEM693ka574TZGwo4IWwS6QLzM/2t" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
<script src="https://code.jquery.com/jquery-3.7.0.slim.min.js" integrity="sha384-w5y/xIeYixWvfM+A1cEbmHPURnvyqmVg5eVENruEdDjcyRLUSNej7512JQGspFUr" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>

<script src="https://blog.pokapu.jp/js/main.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="https://blog.pokapu.jp/js/load-photoswipe.js"></script>










    
  </body>
</html>

