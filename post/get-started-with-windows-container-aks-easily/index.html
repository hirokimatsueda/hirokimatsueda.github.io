<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>自作のWindowsアプリをAKSに載せるキホン技 | 備忘録</title>
<meta name="keywords" content="Kubernetes, Windowsコンテナ, AKS" />
<meta name="description" content="Azure Kubernetes Service(以降、AKS)は Windows コンテナの使用できる構成を作成することができます。
（記事公開時点ではパブリックプレビュー）
Windows コンテナが使える AKS を用意して、アプリを動かしてみましょう。
アプリの作成からインフラの作成まで一通り必要な手順を書いてみましたので、この記事をベースに Windows コンテナの世界に入門していただけたらと思います。
また、アプリ開発、コンテナ作成、AKS 作成を一通り記載しているので、例えばアプリ開発は知識があるけどインフラはちょっと・・・という場合に部分的に参照していただけると嬉しいです。
Azure Cloud Shell とはなんぞや？などの細かい説明は省いていますので、適宜調べながら読み進めていただけたらと思います。
概要  （Windows 環境でしか動作しない）アプリケーションを作成します アプリケーションを載せたコンテナイメージを作成します コンテナイメージをコンテナレジストリ（ACR）に格納します Windows コンテナが動作する AKS を作成します マニフェストファイルを使用して、AKS 上でコンテナを動かします  Web アプリの作成 【作業環境の想定：手元の Windows PC】
Web 上に公開されているサンプルアプリを使っても良いんですが、現実は自社で作成したアプリなどを使用すると思うので、Web アプリの作成からサラッと見てみましょう。
Windows コンテナが必要なケースは、Windows でしか動作しないアプリ、例えば.NET Framework のアプリを使用している場合だと思われます。.NET Framework の ASP.NET MVC アプリを作っておきましょう。
下記サイトから Visual Studio のインストーラをダウンロードします。 https://visualstudio.microsoft.com/ja/downloads/
インストーラを起動し、「ASP.NET と Web 開発」を選択してインストールします。
インストールが成功したら、新規プロジェクトを起動して、C#の ASP.NET MVC アプリを作成しましょう。
ちょっと古めのアプリを載せる想定だと思いますので、.NET Framework は「4.5.2」辺りが良いでしょうか。プロジェクト名は適当で良いので、「MVC」のアプリを作成してください。
アプリが作成されたら、Visual Studio のソリューションエクスプローラーから、Views/Home/Index.cshtml を開き、適当な加工を加えて実行してみてください。例えば下記のような感じでザックリいきましょう。">
<meta name="author" content="">
<link rel="canonical" href="https://hirokimatsueda.github.io/post/get-started-with-windows-container-aks-easily/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.48a18943c2fc15c38a372b8dde1f5e5dc0bc64fa6cb90f5a817d2f8c76b7f3ae.css" integrity="sha256-SKGJQ8L8FcOKNyuN3h9eXcC8ZPpsuQ9agX0vjHa3864=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js" integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://hirokimatsueda.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://hirokimatsueda.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://hirokimatsueda.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://hirokimatsueda.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://hirokimatsueda.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript> 
<script async src="https://www.googletagmanager.com/gtag/js?id=G-TCXXXXXXXX"></script>
<script>
    window.dataLayer = window.dataLayer || [];

    function gtag() {
        dataLayer.push(arguments);
    }
    gtag('js', new Date());

    gtag('config', 'G-M6XY8HL7QN');
</script> <meta property="og:title" content="自作のWindowsアプリをAKSに載せるキホン技" />
<meta property="og:description" content="Azure Kubernetes Service(以降、AKS)は Windows コンテナの使用できる構成を作成することができます。
（記事公開時点ではパブリックプレビュー）
Windows コンテナが使える AKS を用意して、アプリを動かしてみましょう。
アプリの作成からインフラの作成まで一通り必要な手順を書いてみましたので、この記事をベースに Windows コンテナの世界に入門していただけたらと思います。
また、アプリ開発、コンテナ作成、AKS 作成を一通り記載しているので、例えばアプリ開発は知識があるけどインフラはちょっと・・・という場合に部分的に参照していただけると嬉しいです。
Azure Cloud Shell とはなんぞや？などの細かい説明は省いていますので、適宜調べながら読み進めていただけたらと思います。
概要  （Windows 環境でしか動作しない）アプリケーションを作成します アプリケーションを載せたコンテナイメージを作成します コンテナイメージをコンテナレジストリ（ACR）に格納します Windows コンテナが動作する AKS を作成します マニフェストファイルを使用して、AKS 上でコンテナを動かします  Web アプリの作成 【作業環境の想定：手元の Windows PC】
Web 上に公開されているサンプルアプリを使っても良いんですが、現実は自社で作成したアプリなどを使用すると思うので、Web アプリの作成からサラッと見てみましょう。
Windows コンテナが必要なケースは、Windows でしか動作しないアプリ、例えば.NET Framework のアプリを使用している場合だと思われます。.NET Framework の ASP.NET MVC アプリを作っておきましょう。
下記サイトから Visual Studio のインストーラをダウンロードします。 https://visualstudio.microsoft.com/ja/downloads/
インストーラを起動し、「ASP.NET と Web 開発」を選択してインストールします。
インストールが成功したら、新規プロジェクトを起動して、C#の ASP.NET MVC アプリを作成しましょう。
ちょっと古めのアプリを載せる想定だと思いますので、.NET Framework は「4.5.2」辺りが良いでしょうか。プロジェクト名は適当で良いので、「MVC」のアプリを作成してください。
アプリが作成されたら、Visual Studio のソリューションエクスプローラーから、Views/Home/Index.cshtml を開き、適当な加工を加えて実行してみてください。例えば下記のような感じでザックリいきましょう。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://hirokimatsueda.github.io/post/get-started-with-windows-container-aks-easily/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-04-08T21:07:42&#43;09:00" />
<meta property="article:modified_time" content="2020-04-08T21:07:42&#43;09:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="自作のWindowsアプリをAKSに載せるキホン技"/>
<meta name="twitter:description" content="Azure Kubernetes Service(以降、AKS)は Windows コンテナの使用できる構成を作成することができます。
（記事公開時点ではパブリックプレビュー）
Windows コンテナが使える AKS を用意して、アプリを動かしてみましょう。
アプリの作成からインフラの作成まで一通り必要な手順を書いてみましたので、この記事をベースに Windows コンテナの世界に入門していただけたらと思います。
また、アプリ開発、コンテナ作成、AKS 作成を一通り記載しているので、例えばアプリ開発は知識があるけどインフラはちょっと・・・という場合に部分的に参照していただけると嬉しいです。
Azure Cloud Shell とはなんぞや？などの細かい説明は省いていますので、適宜調べながら読み進めていただけたらと思います。
概要  （Windows 環境でしか動作しない）アプリケーションを作成します アプリケーションを載せたコンテナイメージを作成します コンテナイメージをコンテナレジストリ（ACR）に格納します Windows コンテナが動作する AKS を作成します マニフェストファイルを使用して、AKS 上でコンテナを動かします  Web アプリの作成 【作業環境の想定：手元の Windows PC】
Web 上に公開されているサンプルアプリを使っても良いんですが、現実は自社で作成したアプリなどを使用すると思うので、Web アプリの作成からサラッと見てみましょう。
Windows コンテナが必要なケースは、Windows でしか動作しないアプリ、例えば.NET Framework のアプリを使用している場合だと思われます。.NET Framework の ASP.NET MVC アプリを作っておきましょう。
下記サイトから Visual Studio のインストーラをダウンロードします。 https://visualstudio.microsoft.com/ja/downloads/
インストーラを起動し、「ASP.NET と Web 開発」を選択してインストールします。
インストールが成功したら、新規プロジェクトを起動して、C#の ASP.NET MVC アプリを作成しましょう。
ちょっと古めのアプリを載せる想定だと思いますので、.NET Framework は「4.5.2」辺りが良いでしょうか。プロジェクト名は適当で良いので、「MVC」のアプリを作成してください。
アプリが作成されたら、Visual Studio のソリューションエクスプローラーから、Views/Home/Index.cshtml を開き、適当な加工を加えて実行してみてください。例えば下記のような感じでザックリいきましょう。"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://hirokimatsueda.github.io/post/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "自作のWindowsアプリをAKSに載せるキホン技",
      "item": "https://hirokimatsueda.github.io/post/get-started-with-windows-container-aks-easily/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "自作のWindowsアプリをAKSに載せるキホン技",
  "name": "自作のWindowsアプリをAKSに載せるキホン技",
  "description": "Azure Kubernetes Service(以降、AKS)は Windows コンテナの使用できる構成を作成することができます。\n（記事公開時点ではパブリックプレビュー）\nWindows コンテナが使える AKS を用意して、アプリを動かしてみましょう。\nアプリの作成からインフラの作成まで一通り必要な手順を書いてみましたので、この記事をベースに Windows コンテナの世界に入門していただけたらと思います。\nまた、アプリ開発、コンテナ作成、AKS 作成を一通り記載しているので、例えばアプリ開発は知識があるけどインフラはちょっと・・・という場合に部分的に参照していただけると嬉しいです。\nAzure Cloud Shell とはなんぞや？などの細かい説明は省いていますので、適宜調べながら読み進めていただけたらと思います。\n概要  （Windows 環境でしか動作しない）アプリケーションを作成します アプリケーションを載せたコンテナイメージを作成します コンテナイメージをコンテナレジストリ（ACR）に格納します Windows コンテナが動作する AKS を作成します マニフェストファイルを使用して、AKS 上でコンテナを動かします  Web アプリの作成 【作業環境の想定：手元の Windows PC】\nWeb 上に公開されているサンプルアプリを使っても良いんですが、現実は自社で作成したアプリなどを使用すると思うので、Web アプリの作成からサラッと見てみましょう。\nWindows コンテナが必要なケースは、Windows でしか動作しないアプリ、例えば.NET Framework のアプリを使用している場合だと思われます。.NET Framework の ASP.NET MVC アプリを作っておきましょう。\n下記サイトから Visual Studio のインストーラをダウンロードします。 https://visualstudio.microsoft.com/ja/downloads/\nインストーラを起動し、「ASP.NET と Web 開発」を選択してインストールします。\nインストールが成功したら、新規プロジェクトを起動して、C#の ASP.NET MVC アプリを作成しましょう。\nちょっと古めのアプリを載せる想定だと思いますので、.NET Framework は「4.5.2」辺りが良いでしょうか。プロジェクト名は適当で良いので、「MVC」のアプリを作成してください。\nアプリが作成されたら、Visual Studio のソリューションエクスプローラーから、Views/Home/Index.cshtml を開き、適当な加工を加えて実行してみてください。例えば下記のような感じでザックリいきましょう。",
  "keywords": [
    "Kubernetes", "Windowsコンテナ", "AKS"
  ],
  "articleBody": "Azure Kubernetes Service(以降、AKS)は Windows コンテナの使用できる構成を作成することができます。\n（記事公開時点ではパブリックプレビュー）\nWindows コンテナが使える AKS を用意して、アプリを動かしてみましょう。\nアプリの作成からインフラの作成まで一通り必要な手順を書いてみましたので、この記事をベースに Windows コンテナの世界に入門していただけたらと思います。\nまた、アプリ開発、コンテナ作成、AKS 作成を一通り記載しているので、例えばアプリ開発は知識があるけどインフラはちょっと・・・という場合に部分的に参照していただけると嬉しいです。\nAzure Cloud Shell とはなんぞや？などの細かい説明は省いていますので、適宜調べながら読み進めていただけたらと思います。\n概要  （Windows 環境でしか動作しない）アプリケーションを作成します アプリケーションを載せたコンテナイメージを作成します コンテナイメージをコンテナレジストリ（ACR）に格納します Windows コンテナが動作する AKS を作成します マニフェストファイルを使用して、AKS 上でコンテナを動かします  Web アプリの作成 【作業環境の想定：手元の Windows PC】\nWeb 上に公開されているサンプルアプリを使っても良いんですが、現実は自社で作成したアプリなどを使用すると思うので、Web アプリの作成からサラッと見てみましょう。\nWindows コンテナが必要なケースは、Windows でしか動作しないアプリ、例えば.NET Framework のアプリを使用している場合だと思われます。.NET Framework の ASP.NET MVC アプリを作っておきましょう。\n下記サイトから Visual Studio のインストーラをダウンロードします。 https://visualstudio.microsoft.com/ja/downloads/\nインストーラを起動し、「ASP.NET と Web 開発」を選択してインストールします。\nインストールが成功したら、新規プロジェクトを起動して、C#の ASP.NET MVC アプリを作成しましょう。\nちょっと古めのアプリを載せる想定だと思いますので、.NET Framework は「4.5.2」辺りが良いでしょうか。プロジェクト名は適当で良いので、「MVC」のアプリを作成してください。\nアプリが作成されたら、Visual Studio のソリューションエクスプローラーから、Views/Home/Index.cshtml を開き、適当な加工を加えて実行してみてください。例えば下記のような感じでザックリいきましょう。\n@{ ViewBag.Title = \"コンテナアプリのデモ\"; }  \"jumbotron\"  ASP.NET  \"lead\"コンテナでWebアプリを動かしてみよう\n F5 キーでアプリの正常動作を確認したら、アプリケーションを発行しましょう。\nWeb アプリケーションのプロジェクトを右クリックし、「発行」を選ぶと、「公開先の選択」の画面が出ます。\nここで公開先に「フォルダ―」を選び、表示される通り「bin\\Release\\Publish」に公開する状態で「プロファイルの作成」を押してください。\nプロファイルの作成が終わったら画面上に発行用のビューが出ているはずなので、「発行」ボタンを押してください。\nこれでアプリケーションの準備が完了しました！\nサービスプリンシパルの作成 【作業環境の想定：Azure Cloud Shell】\nVM での作業用に、権限を限定したサービスプリンシパルを作成して進めます。\n下記のコマンドを実行し、AKS を作成する対象のサブスクリプション ID での Contributor 権限を持つサービスプリンシパルを作成します。\naz ad sp create-for-rbac --role=\"Contributor\" --scopes=\"/subscriptions/【サブスクリプション ID】\" コマンドを実行すると、自動で生成された ID やパスワードが表示されますので、表示された値を安全な方法で保管してください。\n作業用 VM の作成 【作業環境の想定：Azure ポータル、作業用 VM】\nコンテナイメージの作成をするために VM を用意しましょう。\nちなみに記事執筆時点では、AKS 上で動作する Windows コンテナは Windows Server 2019 系列のものだけです。\n記事執筆時点では AKS はプロセス分離モードしか使用できないため、Windows Server 2019 Datacenter 辺りの VM を用意することが必要です。\nAzure ポータルから適当な Windows Server 2019 の VM を作成します。あまり性能は要らないはずですが、D2s v3 くらいのサイズにしておくと後悔が無いかと思います。設定はデフォルトで良いと思いますが、診断ログや自動停止などはお好みで。\nVM が作成できたら、 VM の Windows Update を実施してください。\nWindows Update の適用が完了したら、Docker EE の導入のため、PowerShell で下記のコマンドを実行します（VM が再起動します）。\nInstall-Module -Name DockerMsftProvider -Repository PSGallery -Force Install-Package -Name Docker -ProviderName DockerMsftProvider -Force Restart-Computer -Force また、Azure が操作できるよう、az cli をインストールしましょう。下記のコマンドを実行します。\nInvoke-WebRequest -Uri https://aka.ms/installazurecliwindows -OutFile .\\AzureCLI.msi; Start-Process msiexec.exe -Wait -ArgumentList '/I AzureCLI.msi /quiet' Dockerfile の作成 【作業環境の想定：作業用 VM】\n作成した VM に下記の Dockerfile を用意します。\n# escape=`FROMmcr.microsoft.com/dotnet/framework/runtime:4.8-windowsservercore-ltsc2019SHELL [\"powershell\", \"-Command\", \"$ErrorActionPreference = 'Stop'; $ProgressPreference = 'SilentlyContinue';\"]RUN Add-WindowsFeature Web-Server; ` Add-WindowsFeature NET-Framework-45-ASPNET; ` Add-WindowsFeature Web-Asp-Net45; ` Remove-Item -Recurse C:\\inetpub\\wwwroot\\*; ` Invoke-WebRequest -Uri https://dotnetbinaries.blob.core.windows.net/servicemonitor/2.0.1.6/ServiceMonitor.exe -OutFile C:\\ServiceMonitor.exe# Install Roslyn compilers and ngen binariesRUN Invoke-WebRequest https://api.nuget.org/packages/microsoft.net.compilers.2.9.0.nupkg -OutFile c:\\microsoft.net.compilers.2.9.0.zip; ` Expand-Archive -Path c:\\microsoft.net.compilers.2.9.0.zip -DestinationPath c:\\RoslynCompilers; ` Remove-Item c:\\microsoft.net.compilers.2.9.0.zip -Force; ` \u0026C:\\Windows\\Microsoft.NET\\Framework64\\v4.0.30319\\ngen.exe install c:\\RoslynCompilers\\tools\\csc.exe /ExeConfig:c:\\RoslynCompilers\\tools\\csc.exe | ` \u0026C:\\Windows\\Microsoft.NET\\Framework64\\v4.0.30319\\ngen.exe install c:\\RoslynCompilers\\tools\\vbc.exe /ExeConfig:c:\\RoslynCompilers\\tools\\vbc.exe | ` \u0026C:\\Windows\\Microsoft.NET\\Framework64\\v4.0.30319\\ngen.exe install c:\\RoslynCompilers\\tools\\VBCSCompiler.exe /ExeConfig:c:\\RoslynCompilers\\tools\\VBCSCompiler.exe | ` \u0026C:\\Windows\\Microsoft.NET\\Framework\\v4.0.30319\\ngen.exe install c:\\RoslynCompilers\\tools\\csc.exe /ExeConfig:c:\\RoslynCompilers\\tools\\csc.exe | ` \u0026C:\\Windows\\Microsoft.NET\\Framework\\v4.0.30319\\ngen.exe install c:\\RoslynCompilers\\tools\\vbc.exe /ExeConfig:c:\\RoslynCompilers\\tools\\vbc.exe | ` \u0026C:\\Windows\\Microsoft.NET\\Framework\\v4.0.30319\\ngen.exe install c:\\RoslynCompilers\\tools\\VBCSCompiler.exe /ExeConfig:c:\\RoslynCompilers\\tools\\VBCSCompiler.exeENV ROSLYN_COMPILER_LOCATION c:\\\\RoslynCompilers\\\\toolsWORKDIRC:\\inetpub\\wwwrootCOPY ${source:-Publish} .EXPOSE80ENTRYPOINT [\"C:\\\\ServiceMonitor.exe\", \"w3svc\"]Windows コンテナで IIS を使用するシンプルな Dockerfile です。\n.NET Framework を動かすため、Windows ServerCore のベースイメージを使用します。\nIIS を使用するため、必要な機能を追加し、ENTRYPOINT で使用する ServiceMonitor を導入しています。\nC:\\Work\\Dockerfile に保存しましょう。\nコンテナイメージの作成 【作業環境の想定：作業用 VM】\nビルドしたアプリを Dockerfile と同じ場所(C:\\Work)にコピーしましょう。\nVisual Studio のソリューションエクスプローラーでプロジェクトを右クリックし、「エクスプローラーでフォルダを開く」を選ぶと、プロジェクトの場所が表示されます。bin/Release/Publish フォルダをコピーし、VM の C:\\Work 内に貼り付けしてください。\nPowerShell 等で下記のコマンドを実行したら、testcontainer というイメージ名のコンテナイメージが作成されます。\ncd C:\\Work docker build -t testcontainer . 結構時間がかかりますが、処理が終わったら完了です。\n正常終了なら、メッセージの最後に下記のような内容が出るはずです。\nSuccessfully built xxxxxxxx Successfully tagged testcontainer:latest 軽くコンテナの動作を確認してみましょう。 下記のコマンドを実行し、コンテナイメージからコンテナを作成します。\ndocker run -itd testcontainer コマンドから復帰したら、下記のコマンドで実行中のコンテナの IP アドレスを取得しましょう。\ndocker exec -it (docker ps -q -f \"ancestor=testcontainer\") powershell ipconfig このコマンドで、docker ps で実行中のコンテナを検索し、その ID を取得し、その ID のコンテナにログインして ipconfig コマンドを実行しています。\n得られた IPv4 Address の値に VM のブラウザからアクセスしてみましょう。\nVisual Studio からデバッグ実行した時と同じ画面が見れましたか？\nACR の作成 【作業環境の想定：Azure ポータル】\nAzure ポータルから ACR を作成します。\n管理者ユーザーは無効、SKU は Basic で構いません。\nACR へのイメージのプッシュ 【作業環境の想定：作業用 VM】\nコンテナイメージを作成した VM に戻り、ACR にコンテナイメージを Push します。\nACR にアクセスする場合、az コマンドに対して認証情報を設定する必要があります。\n下記の PowerShell を実行してください。\naz login --service-principal --username 【サービスプリンシパルの appId の値】 --password 【サービスプリンシパルの password の値】 --tenant 【サービスプリンシパルの tenant の値】 az acr login --name 【作成した ACR のレジストリ名】 成功したら、下記のコマンドを実行し、ACR へイメージをプッシュします。\ndocker tag testcontainer:latest 【作成した ACR のレジストリ名】.azurecr.io/testcontainer:latest docker push 【作成した ACR のレジストリ名】.azurecr.io/testcontainer Azure ポータルで ACR を開くと、リポジトリのビューにプッシュしたイメージが表示されます。\nと言っても文字情報なので、今は「ふ～ん・・」としか言えないですね。\nWindows コンテナが使用可能な AKS の作成 【作業環境の想定：Azure Cloud Shell】\n下記の記事に従い、Windows コンテナが使用可能な AKS を作成しましょう。\nhttps://docs.microsoft.com/ja-jp/azure/aks/windows-container-cli\n手順を転記するとあまりに冗長なので省略します。 下記の記事まで、ほぼそのまま Azure Cloud Shell で実行してください。\nhttps://docs.microsoft.com/ja-jp/azure/aks/windows-container-cli#connect-to-the-cluster\nkubectl get nodes を実行してノードの一覧が表示されること、 kubectl get pods を実行して Pod が何もデプロイされていないことを確認します。\n続いて、AKS が ACR からコンテナイメージをダウンロードできるよう、ACR を AKS にアタッチします。\naz aks update -n myAKSCluster -g myResourceGroup --attach-acr 【ACR 名】 マニフェストファイルの作成 【作業環境の想定：Azure Cloud Shell】\nWeb アプリを使用するためのマニフェストファイルを用意します。 Azure Cloud Shell 上でそのまま vi コマンド等を使って作成してください。\napiVersion: apps/v1 kind: Deployment metadata:  name: application  labels:  app: application spec:  replicas: 1  template:  metadata:  name: application  labels:  app: application  spec:  nodeSelector:  \"beta.kubernetes.io/os\": windows  containers:  - name: application  image: 【作成した ACR のレジストリ名】.azurecr.io/testcontainer:latest  resources:  limits:  cpu: 400m  memory: 800M  requests:  cpu: 400m  memory: 800M  ports:  - containerPort: 80  selector:  matchLabels:  app: application --- apiVersion: v1 kind: Service metadata:  name: application spec:  type: LoadBalancer  ports:  - protocol: TCP  port: 80  selector:  app: application マニフェストファイルの適用と確認 【作業環境の想定：Azure Cloud Shell】\nマニフェストファイルの適用をするため、Azure Cloud Shell から下記のコマンドを実行します。\nkubectl apply -f 【作成したマニフェストファイル】 成功すると Pod が作成されますので、 kubectl get pods で作成した Pod の STATUS を確認しましょう。\n10 分くらいして Pod の STATUS が ContainerCreating から Running になったら、Web アプリが見れることを確認しましょう。\n下記のコマンドで、Pod に外からアクセスするための Service の情報が取得できます。\nkubectl get services EXTERNAL-IP に記載されたグローバル IP に、手元の PC のブラウザからアクセスしてみてください。\n上手くいきましたか？\nまとめ サクッとやれることを示したかったんですが、結構長大になってしまいました。\n覚えることは多いですが、一つひとつの技術的な難易度はお試しで使う分にはあまり高くありませんので、まずはこの記事を参考に動くものを見ていただいて、それから順に深堀して勉強していただけたらと思います。\nWindows コンテナの使える AKS を活用していただける方が増えると嬉しいです。\n",
  "wordCount" : "623",
  "inLanguage": "en",
  "datePublished": "2020-04-08T21:07:42+09:00",
  "dateModified": "2020-04-08T21:07:42+09:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://hirokimatsueda.github.io/post/get-started-with-windows-container-aks-easily/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "備忘録",
    "logo": {
      "@type": "ImageObject",
      "url": "https://hirokimatsueda.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://hirokimatsueda.github.io/" accesskey="h" title="備忘録 (Alt + H)">備忘録</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      自作のWindowsアプリをAKSに載せるキホン技
    </h1>
    <div class="post-meta"><span title='2020-04-08 21:07:42 +0900 JST'>April 8, 2020</span>

</div>
  </header> 
  <div class="post-content"><p>Azure Kubernetes Service(以降、AKS)は Windows コンテナの使用できる構成を作成することができます。</p>
<p>（記事公開時点ではパブリックプレビュー）</p>
<p>Windows コンテナが使える AKS を用意して、アプリを動かしてみましょう。</p>
<p>アプリの作成からインフラの作成まで一通り必要な手順を書いてみましたので、この記事をベースに Windows コンテナの世界に入門していただけたらと思います。</p>
<p>また、アプリ開発、コンテナ作成、AKS 作成を一通り記載しているので、例えばアプリ開発は知識があるけどインフラはちょっと・・・という場合に部分的に参照していただけると嬉しいです。</p>
<p>Azure Cloud Shell とはなんぞや？などの細かい説明は省いていますので、適宜調べながら読み進めていただけたらと思います。</p>
<h2 id="概要">概要<a hidden class="anchor" aria-hidden="true" href="#概要">#</a></h2>
<ul>
<li>（Windows 環境でしか動作しない）アプリケーションを作成します</li>
<li>アプリケーションを載せたコンテナイメージを作成します</li>
<li>コンテナイメージをコンテナレジストリ（ACR）に格納します</li>
<li>Windows コンテナが動作する AKS を作成します</li>
<li>マニフェストファイルを使用して、AKS 上でコンテナを動かします</li>
</ul>
<h2 id="web-アプリの作成">Web アプリの作成<a hidden class="anchor" aria-hidden="true" href="#web-アプリの作成">#</a></h2>
<p>【作業環境の想定：手元の Windows PC】</p>
<p>Web 上に公開されているサンプルアプリを使っても良いんですが、現実は自社で作成したアプリなどを使用すると思うので、Web アプリの作成からサラッと見てみましょう。</p>
<p>Windows コンテナが必要なケースは、Windows でしか動作しないアプリ、例えば.NET Framework のアプリを使用している場合だと思われます。.NET Framework の ASP.NET MVC アプリを作っておきましょう。</p>
<p>下記サイトから Visual Studio のインストーラをダウンロードします。
<a href="https://visualstudio.microsoft.com/ja/downloads/">https://visualstudio.microsoft.com/ja/downloads/</a></p>
<p>インストーラを起動し、「ASP.NET と Web 開発」を選択してインストールします。</p>
<p>インストールが成功したら、新規プロジェクトを起動して、C#の ASP.NET MVC アプリを作成しましょう。</p>
<p>ちょっと古めのアプリを載せる想定だと思いますので、.NET Framework は「4.5.2」辺りが良いでしょうか。プロジェクト名は適当で良いので、「MVC」のアプリを作成してください。</p>
<p>アプリが作成されたら、Visual Studio のソリューションエクスプローラーから、Views/Home/Index.cshtml を開き、適当な加工を加えて実行してみてください。例えば下記のような感じでザックリいきましょう。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">@</span>{
</span></span><span style="display:flex;"><span>ViewBag.Title = <span style="color:#e6db74">&#34;コンテナアプリのデモ&#34;</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&lt;div class=<span style="color:#e6db74">&#34;jumbotron&#34;</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;h1&gt;ASP.NET&lt;/h1&gt;
</span></span><span style="display:flex;"><span>    &lt;p class=<span style="color:#e6db74">&#34;lead&#34;</span>&gt;<span style="color:#960050;background-color:#1e0010">コンテナで</span>Webアプリを動かしてみよう&lt;/p&gt;
</span></span><span style="display:flex;"><span>&lt;/div&gt;
</span></span></code></pre></div><p>F5 キーでアプリの正常動作を確認したら、アプリケーションを発行しましょう。</p>
<p>Web アプリケーションのプロジェクトを右クリックし、「発行」を選ぶと、「公開先の選択」の画面が出ます。</p>
<p>ここで公開先に「フォルダ―」を選び、表示される通り「bin\Release\Publish」に公開する状態で「プロファイルの作成」を押してください。</p>
<p>プロファイルの作成が終わったら画面上に発行用のビューが出ているはずなので、「発行」ボタンを押してください。</p>
<p>これでアプリケーションの準備が完了しました！</p>
<h2 id="サービスプリンシパルの作成">サービスプリンシパルの作成<a hidden class="anchor" aria-hidden="true" href="#サービスプリンシパルの作成">#</a></h2>
<p>【作業環境の想定：Azure Cloud Shell】</p>
<p>VM での作業用に、権限を限定したサービスプリンシパルを作成して進めます。</p>
<p>下記のコマンドを実行し、AKS を作成する対象のサブスクリプション ID での Contributor 権限を持つサービスプリンシパルを作成します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>az ad sp create-for-rbac --role<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Contributor&#34;</span> --scopes<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/subscriptions/【サブスクリプション ID】&#34;</span>
</span></span></code></pre></div><p>コマンドを実行すると、自動で生成された ID やパスワードが表示されますので、表示された値を安全な方法で保管してください。</p>
<h2 id="作業用-vm-の作成">作業用 VM の作成<a hidden class="anchor" aria-hidden="true" href="#作業用-vm-の作成">#</a></h2>
<p>【作業環境の想定：Azure ポータル、作業用 VM】</p>
<p>コンテナイメージの作成をするために VM を用意しましょう。</p>
<p>ちなみに記事執筆時点では、AKS 上で動作する Windows コンテナは Windows Server 2019 系列のものだけです。</p>
<p>記事執筆時点では AKS はプロセス分離モードしか使用できないため、Windows Server 2019 Datacenter 辺りの VM を用意することが必要です。</p>
<p>Azure ポータルから適当な Windows Server 2019 の VM を作成します。あまり性能は要らないはずですが、D2s v3 くらいのサイズにしておくと後悔が無いかと思います。設定はデフォルトで良いと思いますが、診断ログや自動停止などはお好みで。</p>
<p>VM が作成できたら、 VM の Windows Update を実施してください。</p>
<p>Windows Update の適用が完了したら、Docker EE の導入のため、PowerShell で下記のコマンドを実行します（VM が再起動します）。</p>
<pre tabindex="0"><code class="language-pwsh" data-lang="pwsh">Install-Module -Name DockerMsftProvider -Repository PSGallery -Force
Install-Package -Name Docker -ProviderName DockerMsftProvider -Force
Restart-Computer -Force
</code></pre><p>また、Azure が操作できるよう、az cli をインストールしましょう。下記のコマンドを実行します。</p>
<pre tabindex="0"><code class="language-pwsh" data-lang="pwsh">Invoke-WebRequest -Uri https://aka.ms/installazurecliwindows -OutFile .\AzureCLI.msi; Start-Process msiexec.exe -Wait -ArgumentList &#39;/I AzureCLI.msi /quiet&#39;
</code></pre><h2 id="dockerfile-の作成">Dockerfile の作成<a hidden class="anchor" aria-hidden="true" href="#dockerfile-の作成">#</a></h2>
<p>【作業環境の想定：作業用 VM】</p>
<p>作成した VM に下記の Dockerfile を用意します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#75715e"># escape=`</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> mcr.microsoft.com/dotnet/framework/runtime:4.8-windowsservercore-ltsc2019</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">SHELL</span> [<span style="color:#e6db74">&#34;powershell&#34;</span>, <span style="color:#e6db74">&#34;-Command&#34;</span>, <span style="color:#e6db74">&#34;$ErrorActionPreference = &#39;Stop&#39;; $ProgressPreference = &#39;SilentlyContinue&#39;;&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> Add-WindowsFeature Web-Server; <span style="color:#e6db74">`</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    Add-WindowsFeature NET-Framework-45-ASPNET; <span style="color:#e6db74">`</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    Add-WindowsFeature Web-Asp-Net45; <span style="color:#e6db74">`</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    Remove-Item -Recurse C:<span style="color:#ae81ff">\i</span>netpub<span style="color:#ae81ff">\w</span>wwroot<span style="color:#ae81ff">\*</span>; <span style="color:#e6db74">`</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    Invoke-WebRequest -Uri https://dotnetbinaries.blob.core.windows.net/servicemonitor/2.0.1.6/ServiceMonitor.exe -OutFile C:<span style="color:#ae81ff">\S</span>erviceMonitor.exe<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Install Roslyn compilers and ngen binaries</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> Invoke-WebRequest https://api.nuget.org/packages/microsoft.net.compilers.2.9.0.nupkg -OutFile c:<span style="color:#ae81ff">\m</span>icrosoft.net.compilers.2.9.0.zip; <span style="color:#e6db74">`</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    Expand-Archive -Path c:<span style="color:#ae81ff">\m</span>icrosoft.net.compilers.2.9.0.zip -DestinationPath c:<span style="color:#ae81ff">\R</span>oslynCompilers; <span style="color:#e6db74">`</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    Remove-Item c:<span style="color:#ae81ff">\m</span>icrosoft.net.compilers.2.9.0.zip -Force; <span style="color:#e6db74">`</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    &amp;C:<span style="color:#ae81ff">\W</span>indows<span style="color:#ae81ff">\M</span>icrosoft.NET<span style="color:#ae81ff">\F</span>ramework64<span style="color:#ae81ff">\v</span>4.0.30319<span style="color:#ae81ff">\n</span>gen.exe install c:<span style="color:#ae81ff">\R</span>oslynCompilers<span style="color:#ae81ff">\t</span>ools<span style="color:#ae81ff">\c</span>sc.exe /ExeConfig:c:<span style="color:#ae81ff">\R</span>oslynCompilers<span style="color:#ae81ff">\t</span>ools<span style="color:#ae81ff">\c</span>sc.exe | <span style="color:#e6db74">`</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    &amp;C:<span style="color:#ae81ff">\W</span>indows<span style="color:#ae81ff">\M</span>icrosoft.NET<span style="color:#ae81ff">\F</span>ramework64<span style="color:#ae81ff">\v</span>4.0.30319<span style="color:#ae81ff">\n</span>gen.exe install c:<span style="color:#ae81ff">\R</span>oslynCompilers<span style="color:#ae81ff">\t</span>ools<span style="color:#ae81ff">\v</span>bc.exe /ExeConfig:c:<span style="color:#ae81ff">\R</span>oslynCompilers<span style="color:#ae81ff">\t</span>ools<span style="color:#ae81ff">\v</span>bc.exe | <span style="color:#e6db74">`</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    &amp;C:<span style="color:#ae81ff">\W</span>indows<span style="color:#ae81ff">\M</span>icrosoft.NET<span style="color:#ae81ff">\F</span>ramework64<span style="color:#ae81ff">\v</span>4.0.30319<span style="color:#ae81ff">\n</span>gen.exe install c:<span style="color:#ae81ff">\R</span>oslynCompilers<span style="color:#ae81ff">\t</span>ools<span style="color:#ae81ff">\V</span>BCSCompiler.exe /ExeConfig:c:<span style="color:#ae81ff">\R</span>oslynCompilers<span style="color:#ae81ff">\t</span>ools<span style="color:#ae81ff">\V</span>BCSCompiler.exe | <span style="color:#e6db74">`</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    &amp;C:<span style="color:#ae81ff">\W</span>indows<span style="color:#ae81ff">\M</span>icrosoft.NET<span style="color:#ae81ff">\F</span>ramework<span style="color:#ae81ff">\v</span>4.0.30319<span style="color:#ae81ff">\n</span>gen.exe install c:<span style="color:#ae81ff">\R</span>oslynCompilers<span style="color:#ae81ff">\t</span>ools<span style="color:#ae81ff">\c</span>sc.exe /ExeConfig:c:<span style="color:#ae81ff">\R</span>oslynCompilers<span style="color:#ae81ff">\t</span>ools<span style="color:#ae81ff">\c</span>sc.exe | <span style="color:#e6db74">`</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    &amp;C:<span style="color:#ae81ff">\W</span>indows<span style="color:#ae81ff">\M</span>icrosoft.NET<span style="color:#ae81ff">\F</span>ramework<span style="color:#ae81ff">\v</span>4.0.30319<span style="color:#ae81ff">\n</span>gen.exe install c:<span style="color:#ae81ff">\R</span>oslynCompilers<span style="color:#ae81ff">\t</span>ools<span style="color:#ae81ff">\v</span>bc.exe /ExeConfig:c:<span style="color:#ae81ff">\R</span>oslynCompilers<span style="color:#ae81ff">\t</span>ools<span style="color:#ae81ff">\v</span>bc.exe | <span style="color:#e6db74">`</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    &amp;C:<span style="color:#ae81ff">\W</span>indows<span style="color:#ae81ff">\M</span>icrosoft.NET<span style="color:#ae81ff">\F</span>ramework<span style="color:#ae81ff">\v</span>4.0.30319<span style="color:#ae81ff">\n</span>gen.exe install c:<span style="color:#ae81ff">\R</span>oslynCompilers<span style="color:#ae81ff">\t</span>ools<span style="color:#ae81ff">\V</span>BCSCompiler.exe /ExeConfig:c:<span style="color:#ae81ff">\R</span>oslynCompilers<span style="color:#ae81ff">\t</span>ools<span style="color:#ae81ff">\V</span>BCSCompiler.exe<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> ROSLYN_COMPILER_LOCATION c:<span style="color:#ae81ff">\\</span>RoslynCompilers<span style="color:#ae81ff">\\</span>tools<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> C:\inetpub\wwwroot</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> <span style="color:#e6db74">${</span>source<span style="color:#66d9ef">:-</span>Publish<span style="color:#e6db74">}</span> .<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span><span style="color:#e6db74"> 80</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENTRYPOINT</span> [<span style="color:#e6db74">&#34;C:\\ServiceMonitor.exe&#34;</span>, <span style="color:#e6db74">&#34;w3svc&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>Windows コンテナで IIS を使用するシンプルな Dockerfile です。</p>
<p>.NET Framework を動かすため、Windows ServerCore のベースイメージを使用します。</p>
<p>IIS を使用するため、必要な機能を追加し、ENTRYPOINT で使用する ServiceMonitor を導入しています。</p>
<p><code>C:\Work\Dockerfile</code> に保存しましょう。</p>
<h2 id="コンテナイメージの作成">コンテナイメージの作成<a hidden class="anchor" aria-hidden="true" href="#コンテナイメージの作成">#</a></h2>
<p>【作業環境の想定：作業用 VM】</p>
<p>ビルドしたアプリを Dockerfile と同じ場所(C:\Work)にコピーしましょう。</p>
<p>Visual Studio のソリューションエクスプローラーでプロジェクトを右クリックし、「エクスプローラーでフォルダを開く」を選ぶと、プロジェクトの場所が表示されます。<code>bin/Release/Publish</code> フォルダをコピーし、VM の <code>C:\Work</code> 内に貼り付けしてください。</p>
<p>PowerShell 等で下記のコマンドを実行したら、testcontainer というイメージ名のコンテナイメージが作成されます。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span><span style="color:#66d9ef">cd</span> C:\Work
</span></span><span style="display:flex;"><span>docker build -t testcontainer .
</span></span></code></pre></div><p>結構時間がかかりますが、処理が終わったら完了です。</p>
<p>正常終了なら、メッセージの最後に下記のような内容が出るはずです。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span>Successfully built xxxxxxxx
</span></span><span style="display:flex;"><span>Successfully tagged testcontainer:latest
</span></span></code></pre></div><p>軽くコンテナの動作を確認してみましょう。
下記のコマンドを実行し、コンテナイメージからコンテナを作成します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span>docker run -itd testcontainer
</span></span></code></pre></div><p>コマンドから復帰したら、下記のコマンドで実行中のコンテナの IP アドレスを取得しましょう。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span>docker exec -it (docker ps -q -f <span style="color:#e6db74">&#34;ancestor=testcontainer&#34;</span>) powershell ipconfig
</span></span></code></pre></div><p>このコマンドで、docker ps で実行中のコンテナを検索し、その ID を取得し、その ID のコンテナにログインして ipconfig コマンドを実行しています。</p>
<p>得られた IPv4 Address の値に VM のブラウザからアクセスしてみましょう。</p>
<p>Visual Studio からデバッグ実行した時と同じ画面が見れましたか？</p>
<h2 id="acr-の作成">ACR の作成<a hidden class="anchor" aria-hidden="true" href="#acr-の作成">#</a></h2>
<p>【作業環境の想定：Azure ポータル】</p>
<p>Azure ポータルから ACR を作成します。</p>
<p>管理者ユーザーは無効、SKU は Basic で構いません。</p>
<h2 id="acr-へのイメージのプッシュ">ACR へのイメージのプッシュ<a hidden class="anchor" aria-hidden="true" href="#acr-へのイメージのプッシュ">#</a></h2>
<p>【作業環境の想定：作業用 VM】</p>
<p>コンテナイメージを作成した VM に戻り、ACR にコンテナイメージを Push します。</p>
<p>ACR にアクセスする場合、az コマンドに対して認証情報を設定する必要があります。</p>
<p>下記の PowerShell を実行してください。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>az login --service-principal --username 【サービスプリンシパルの appId の値】 --password 【サービスプリンシパルの password の値】 --tenant 【サービスプリンシパルの tenant の値】
</span></span><span style="display:flex;"><span>az acr login --name 【作成した ACR のレジストリ名】
</span></span></code></pre></div><p>成功したら、下記のコマンドを実行し、ACR へイメージをプッシュします。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>docker tag testcontainer:latest 【作成した ACR のレジストリ名】.azurecr.io/testcontainer:latest
</span></span><span style="display:flex;"><span>docker push 【作成した ACR のレジストリ名】.azurecr.io/testcontainer
</span></span></code></pre></div><p>Azure ポータルで ACR を開くと、リポジトリのビューにプッシュしたイメージが表示されます。</p>
<p>と言っても文字情報なので、今は「ふ～ん・・」としか言えないですね。</p>
<h2 id="windows-コンテナが使用可能な-aks-の作成">Windows コンテナが使用可能な AKS の作成<a hidden class="anchor" aria-hidden="true" href="#windows-コンテナが使用可能な-aks-の作成">#</a></h2>
<p>【作業環境の想定：Azure Cloud Shell】</p>
<p>下記の記事に従い、Windows コンテナが使用可能な AKS を作成しましょう。</p>
<p><a href="https://docs.microsoft.com/ja-jp/azure/aks/windows-container-cli">https://docs.microsoft.com/ja-jp/azure/aks/windows-container-cli</a></p>
<p>手順を転記するとあまりに冗長なので省略します。
下記の記事まで、ほぼそのまま Azure Cloud Shell で実行してください。</p>
<p><a href="https://docs.microsoft.com/ja-jp/azure/aks/windows-container-cli#connect-to-the-cluster">https://docs.microsoft.com/ja-jp/azure/aks/windows-container-cli#connect-to-the-cluster</a></p>
<p><code>kubectl get nodes</code> を実行してノードの一覧が表示されること、 <code>kubectl get pods</code> を実行して Pod が何もデプロイされていないことを確認します。</p>
<p>続いて、AKS が ACR からコンテナイメージをダウンロードできるよう、ACR を AKS にアタッチします。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>az aks update -n myAKSCluster -g myResourceGroup --attach-acr 【ACR 名】
</span></span></code></pre></div><h2 id="マニフェストファイルの作成">マニフェストファイルの作成<a hidden class="anchor" aria-hidden="true" href="#マニフェストファイルの作成">#</a></h2>
<p>【作業環境の想定：Azure Cloud Shell】</p>
<p>Web アプリを使用するためのマニフェストファイルを用意します。
Azure Cloud Shell 上でそのまま vi コマンド等を使って作成してください。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">application</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">application</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">application</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">application</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">nodeSelector</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;beta.kubernetes.io/os&#34;: </span><span style="color:#ae81ff">windows</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">application</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">image</span>: <span style="color:#ae81ff">【作成した ACR のレジストリ名】.azurecr.io/testcontainer:latest</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">limits</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">400m</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">800M</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">400m</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">800M</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">application</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">application</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">LoadBalancer</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">application</span>
</span></span></code></pre></div><h2 id="マニフェストファイルの適用と確認">マニフェストファイルの適用と確認<a hidden class="anchor" aria-hidden="true" href="#マニフェストファイルの適用と確認">#</a></h2>
<p>【作業環境の想定：Azure Cloud Shell】</p>
<p>マニフェストファイルの適用をするため、Azure Cloud Shell から下記のコマンドを実行します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kubectl apply -f 【作成したマニフェストファイル】
</span></span></code></pre></div><p>成功すると Pod が作成されますので、 kubectl get pods で作成した Pod の STATUS を確認しましょう。</p>
<p>10 分くらいして Pod の STATUS が ContainerCreating から Running になったら、Web アプリが見れることを確認しましょう。</p>
<p>下記のコマンドで、Pod に外からアクセスするための Service の情報が取得できます。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kubectl get services
</span></span></code></pre></div><p>EXTERNAL-IP に記載されたグローバル IP に、手元の PC のブラウザからアクセスしてみてください。</p>
<p>上手くいきましたか？</p>
<h2 id="まとめ">まとめ<a hidden class="anchor" aria-hidden="true" href="#まとめ">#</a></h2>
<p>サクッとやれることを示したかったんですが、結構長大になってしまいました。</p>
<p>覚えることは多いですが、一つひとつの技術的な難易度はお試しで使う分にはあまり高くありませんので、まずはこの記事を参考に動くものを見ていただいて、それから順に深堀して勉強していただけたらと思います。</p>
<p>Windows コンテナの使える AKS を活用していただける方が増えると嬉しいです。</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://hirokimatsueda.github.io/tags/kubernetes/">Kubernetes</a></li>
      <li><a href="https://hirokimatsueda.github.io/tags/windows%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A/">Windowsコンテナ</a></li>
      <li><a href="https://hirokimatsueda.github.io/tags/aks/">AKS</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>Copyright © 2022 Hiroki Matsueda</span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
    <span>
        <a href="/privacy/" rel="noopener" target="_blank">プライバシーポリシー</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function() {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function(e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });
</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function() {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };
</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })
</script></body>

</html>
